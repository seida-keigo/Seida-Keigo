<link href="style.css" rel="stylesheet">
<style>
	html,body{
		height:calc(100% - 16px);
	}
</style>
<audio controls id="audio1">
</audio>
<audio controls id="audio2">
</audio>
<button id="start">スタート</button>
<script>
	let tracks=[{
		src:"tracks/1.mp3",currentTime:0,playbackRate:140/138,BEATS:0x80
	}/*,{
		src:"tracks/2.mp3",currentTime:0x70*60/143,playbackRate:140/143,BEATS:0xc0
	},{
		src:"tracks/3.mp3",currentTime:5.6,playbackRate:140/136,BEATS:0xa4
	},{
		src:"tracks/4.mp3",currentTime:4.5,playbackRate:140/162,BEATS:0x80
	}*/];
	Object.assign(audio1,{
		preservesPitch:false,volume:1/64
	},tracks[~~(tracks.length*Math.random())]);
	Object.assign(audio2,{
		preservesPitch:false,volume:1/64
	},tracks[~~(tracks.length*Math.random())]);
	start.onclick=()=>{
		setInterval(()=>{
			if(audio1.paused&&audio2.paused) audio1.play(),fadeIn((new Date).getTime());
			if(audio2.BEATS==0) audio1.play(),fade2To1((new Date).getTime());
			if(audio1.BEATS==0) audio2.play(),fade1To2((new Date).getTime());
			if(!audio1.paused) --audio1.BEATS;
			if(!audio2.paused) --audio2.BEATS;
			/**/console.log(audio1.BEATS,audio2.BEATS);
		},60e3/140);
		onclick=null;
	}
	let duration=16*60e3/140;
	let fadeIn=startTime=>{
		let now=(new Date).getTime();
		if(now<startTime+duration){
			audio1.volume=Math.min((now-startTime)/duration,1);
			setTimeout(fadeIn,undefined,startTime);
		}
		else audio1.volume=1;
	}
	let fade1To2=startTime=>{
		let now=(new Date).getTime();
		if(now<startTime+duration){
			audio1.volume=Math.max(1-(now-startTime)/duration,0);
			audio2.volume=Math.min((now-startTime)/duration,1);
			setTimeout(fade1To2,undefined,startTime);
		}
		else{
			audio2.volume=1;
			audio1.pause();
			audio1.volume=0;
			Object.assign(audio1,tracks[~~(tracks.length*Math.random())]);
		}
	}
	let fade2To1=startTime=>{
		let now=(new Date).getTime();
		if(now<startTime+duration){
			audio1.volume=Math.min((now-startTime)/duration,1);
			audio2.volume=Math.max(1-(now-startTime)/duration,0);
			setTimeout(fade2To1,undefined,startTime);
		}
		else{
			audio1.volume=1;
			audio2.pause();
			audio2.volume=0;
			Object.assign(audio2,tracks[~~(tracks.length*Math.random())]);
		}
	}
</script>